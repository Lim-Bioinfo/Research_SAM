library(limma)

data <- read.table("../Result/GSE_merged_batchcorrected.gct", header = TRUE, sep = "\t")
rownames(data) <- data$NAME  # Replace 'GeneSymbol' with the actual column name that contains gene symbols
data <- data[, -which(names(data) == "NAME")]
num_index <- nrow(data)

#data  <- subset(data , select=-DESCRIPTION)
N <- ncol(data)
conditions <- factor(c("None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "Primary",
                       "Primary",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "None",
                       "Primary",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "None",
                       "None",
                       "None",
                       "None",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Metastasis",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "Primary",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None",
                       "None"))

# Create a design matrix
design <- model.matrix(~ 0 + conditions)

# Fit linear models for microarray data
fit <- lmFit(data, design)

# Create contrasts (comparing Metastasis to Primary)
contrast.matrix <- makeContrasts(MetastasisVsPrimary = conditionsMetastasis - conditionsPrimary, levels = design)
fit2 <- contrasts.fit(fit, contrast.matrix)

# Apply empirical Bayes statistics
fit2 <- eBayes(fit2)

# Extract top differentially expressed genes
topGenes <- topTable(fit2, number = num_index, adjust.method="fdr")

write.csv(topGenes, "../Result/GSE_merged_limma_DGE_results.csv")
